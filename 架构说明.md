# 项目架构重构说明

## 当前问题
- 单个 HTML 文件包含所有代码（1000+ 行）
- 功能耦合严重，难以维护
- 代码复用性差

## 重构方案

### 模块化架构

```
Kimi_Agent_Deployment_v1/
├── index.html (主文件，只包含 HTML 结构)
├── css/
│   ├── base.css (基础样式)
│   ├── components.css (组件样式)
│   └── layout.css (布局样式)
├── js/
│   ├── storage.js (数据存储模块)
│   ├── imageUtils.js (图片处理模块)
│   ├── dragManager.js (拖拽管理模块)
│   ├── annotationManager.js (组件管理模块)
│   ├── notebookManager.js (笔记本管理模块)
│   ├── chapterManager.js (章节管理模块)
│   ├── uiManager.js (UI 管理模块)
│   └── app.js (主应用入口)
└── data/
    └── defaultData.js (默认数据)
```

### 模块职责

#### 1. storage.js - 数据存储
- localStorage 操作封装
- 数据序列化/反序列化
- 错误处理

#### 2. imageUtils.js - 图片处理
- 图片压缩
- 加载提示
- 格式转换

#### 3. dragManager.js - 拖拽管理
- 拖拽状态管理
- 鼠标事件处理
- 碰撞检测

#### 4. annotationManager.js - 组件管理
- 创建/删除组件
- 组件事件绑定
- 组件保存/加载

#### 5. notebookManager.js - 笔记本管理
- 笔记本 CRUD
- 笔记本切换
- 笔记本渲染

#### 6. chapterManager.js - 章节管理
- 章节 CRUD
- 章节切换
- 章节渲染

#### 7. uiManager.js - UI 管理
- 侧边栏控制
- 全屏模式
- 工具栏交互

#### 8. app.js - 主应用
- 模块初始化
- 事件协调
- 全局状态管理

### 优势

✅ **可维护性**：每个模块职责单一，易于理解和修改
✅ **可测试性**：模块独立，可以单独测试
✅ **可扩展性**：新增功能只需添加新模块
✅ **代码复用**：模块可以在其他项目中复用
✅ **团队协作**：不同开发者可以并行开发不同模块

### 实施步骤

1. ✅ 创建模块文件结构
2. ✅ 提取 JS 模块
3. ✅ 重构主 HTML 文件
4. ⏳ 测试和优化
5. ⏳ 添加笔记本和章节管理功能

## 迁移完成状态

### 已完成
- ✅ 创建所有模块文件（storage.js, imageUtils.js, dragManager.js, annotationManager.js, app.js）
- ✅ 创建模块化 HTML 文件（little-prince-journal-modular.html）
- ✅ 所有功能保持不变
- ✅ 代码无语法错误

### 文件对比
- **原始版本**: `little-prince-journal.html` (~1600 行，单文件)
- **模块化版本**: `little-prince-journal-modular.html` (~830 行) + 5 个 JS 模块文件

### 使用方法
直接在浏览器中打开 `little-prince-journal-modular.html` 即可使用。

**注意**: 如果浏览器因安全策略限制本地文件加载，请使用本地服务器（如 VS Code 的 Live Server 扩展）。

### 模块间通信

使用事件系统进行模块间通信：

```javascript
// 发送事件
window.dispatchEvent(new CustomEvent('annotationsChanged', { 
    detail: { data: annotations } 
}));

// 监听事件
window.addEventListener('annotationsChanged', (e) => {
    Storage.saveAnnotations(e.detail.data);
});
```

### 下一步

建议先完成当前功能的开发，然后再进行重构。重构时可以：
1. 逐步迁移，不影响现有功能
2. 保留原文件作为备份
3. 使用版本控制（Git）管理变更
