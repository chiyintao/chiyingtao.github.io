# 导出功能设计方案

## 当前存储方式分析

### 现状
目前使用 **localStorage** 存储所有数据：

```javascript
// 笔记本列表
localStorage: 'notebooks' → [{id, name, icon}, ...]

// 章节数据（每个笔记本独立）
localStorage: 'chapters_1' → [{id, title, subtitle, date, pageCount, content}, ...]

// 页面内容（每页独立）
localStorage: 'page_0_0' → HTML内容

// 组件数据（每页独立）
localStorage: 'annotations_0_0' → [{id, className, left, top, width, height, transform, content}, ...]
```

### 问题
1. **数据分散** - 一个笔记本的数据分散在多个 localStorage 键中
2. **容量限制** - localStorage 通常只有 5-10MB
3. **无法备份** - 清除浏览器数据会丢失所有内容
4. **无法同步** - 不同设备/浏览器无法共享数据
5. **无法协作** - 单用户使用，无法多人编辑

## 导出功能方案

### 方案一：JSON 格式导出（推荐用于备份）

#### 优点
- ✅ 完整保存所有数据
- ✅ 可以重新导入
- ✅ 文件小，易于传输
- ✅ 开发简单

#### 缺点
- ❌ 不适合阅读
- ❌ 需要专门的导入功能

#### 数据结构
```json
{
  "version": "1.0",
  "exportDate": "2026-02-05T10:30:00Z",
  "notebooks": [
    {
      "id": 1,
      "name": "The Little Prince",
      "icon": "📖",
      "chapters": [
        {
          "id": 123456,
          "title": "Chapter 1",
          "subtitle": "The Beginning",
          "date": "Day 1",
          "pages": [
            {
              "index": 0,
              "content": "<p>...</p>",
              "annotations": [
                {
                  "type": "sticky-note",
                  "position": {x: 100, y: 100},
                  "size": {width: 200, height: 200},
                  "rotation": 0,
                  "content": "Note text"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### 方案二：HTML 格式导出（推荐用于分享）

#### 优点
- ✅ 可以直接在浏览器打开
- ✅ 保留样式和布局
- ✅ 适合打印和分享
- ✅ 无需特殊软件

#### 缺点
- ❌ 文件较大
- ❌ 无法重新导入编辑
- ❌ 组件位置可能不完美

#### 实现方式
```html
<!DOCTYPE html>
<html>
<head>
    <title>The Little Prince - Export</title>
    <style>/* 复制应用的CSS */</style>
</head>
<body>
    <div class="notebook">
        <h1>The Little Prince</h1>
        <div class="chapter">
            <h2>Chapter 1: The Drawing</h2>
            <div class="page">
                <!-- 页面内容 + 组件 -->
            </div>
        </div>
    </div>
</body>
</html>
```

### 方案三：PDF 格式导出（推荐用于打印）

#### 优点
- ✅ 专业格式
- ✅ 适合打印
- ✅ 跨平台兼容
- ✅ 保留布局

#### 缺点
- ❌ 需要第三方库（如 jsPDF）
- ❌ 文件较大
- ❌ 无法编辑

#### 实现方式
使用 `html2canvas` + `jsPDF`：
```javascript
html2canvas(element).then(canvas => {
    const pdf = new jsPDF();
    pdf.addImage(canvas, 'PNG', 0, 0);
    pdf.save('notebook.pdf');
});
```

### 方案四：Markdown 格式导出（推荐用于纯文本）

#### 优点
- ✅ 纯文本，易于编辑
- ✅ 兼容性好
- ✅ 文件小
- ✅ 可以用其他工具打开

#### 缺点
- ❌ 丢失组件信息
- ❌ 丢失布局
- ❌ 图片需要单独处理

#### 示例
```markdown
# The Little Prince

## Chapter 1: The Drawing
*Day 1*

### Page 1

Once when I was six years old...

![Image](data:image/png;base64,...)

---

### Page 2

I showed my masterpiece...
```

## 推荐的产品级方案

### 短期方案（MVP）

#### 1. JSON 导出/导入
- **导出**: 一键导出所有数据为 JSON 文件
- **导入**: 上传 JSON 文件恢复数据
- **用途**: 备份、迁移、恢复

#### 2. HTML 导出
- **导出**: 导出单个笔记本为 HTML
- **用途**: 分享、阅读、归档

### 中期方案（增强版）

#### 1. 云端存储
- **后端**: Node.js + MongoDB/PostgreSQL
- **同步**: 实时同步到云端
- **多设备**: 支持多设备访问
- **协作**: 支持多人编辑（可选）

#### 2. 多格式导出
- JSON（完整数据）
- HTML（可读版本）
- PDF（打印版本）
- Markdown（纯文本）

#### 3. 选择性导出
- 导出单个笔记本
- 导出单个章节
- 导出单个页面
- 批量导出

### 长期方案（企业级）

#### 1. 完整的后端系统
```
前端 (React/Vue)
    ↓
API Gateway
    ↓
微服务架构
    ├── 用户服务 (认证/授权)
    ├── 笔记服务 (CRUD)
    ├── 存储服务 (文件/图片)
    ├── 同步服务 (实时同步)
    └── 导出服务 (多格式导出)
    ↓
数据库 (PostgreSQL + Redis)
    ↓
对象存储 (S3/OSS)
```

#### 2. 高级功能
- **版本控制**: Git-like 版本管理
- **协作编辑**: 实时多人协作
- **权限管理**: 分享权限控制
- **全文搜索**: Elasticsearch
- **AI 辅助**: 智能摘要、标签建议
- **模板市场**: 笔记模板分享

#### 3. 多端支持
- Web 应用
- 桌面应用 (Electron)
- 移动应用 (React Native)
- 浏览器插件

## 实现优先级

### P0 - 必须有（当前版本）
1. ✅ localStorage 存储
2. ⏳ JSON 导出
3. ⏳ JSON 导入

### P1 - 应该有（下一版本）
1. ⏳ HTML 导出
2. ⏳ 选择性导出（单个笔记本）
3. ⏳ 自动备份提醒

### P2 - 可以有（未来版本）
1. ⏳ PDF 导出
2. ⏳ Markdown 导出
3. ⏳ 云端同步
4. ⏳ 多设备支持

### P3 - 锦上添花（长期规划）
1. ⏳ 协作编辑
2. ⏳ 版本控制
3. ⏳ AI 功能
4. ⏳ 移动应用

## 具体实现建议

### 立即实现：JSON 导出/导入

#### 导出功能
```javascript
// 在 storage.js 中添加
exportAllData() {
    const data = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        notebooks: Storage.loadNotebooks(),
        chapters: {},
        pages: {},
        annotations: {}
    };
    
    // 收集所有章节数据
    data.notebooks.forEach(nb => {
        data.chapters[nb.id] = Storage.loadChapters(nb.id);
    });
    
    // 收集所有页面和组件数据
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith('page_')) {
            data.pages[key] = localStorage.getItem(key);
        }
        if (key.startsWith('annotations_')) {
            data.annotations[key] = localStorage.getItem(key);
        }
    });
    
    return data;
}
```

#### 导入功能
```javascript
importAllData(data) {
    if (data.version !== '1.0') {
        throw new Error('Unsupported version');
    }
    
    // 清空现有数据（可选）
    if (confirm('This will replace all existing data. Continue?')) {
        // 导入笔记本
        Storage.saveNotebooks(data.notebooks);
        
        // 导入章节
        Object.keys(data.chapters).forEach(nbId => {
            Storage.saveChapters(nbId, data.chapters[nbId]);
        });
        
        // 导入页面和组件
        Object.keys(data.pages).forEach(key => {
            localStorage.setItem(key, data.pages[key]);
        });
        Object.keys(data.annotations).forEach(key => {
            localStorage.setItem(key, data.annotations[key]);
        });
        
        return true;
    }
    return false;
}
```

#### UI 实现
在侧边栏底部添加导出/导入按钮：
```html
<div class="export-section">
    <button onclick="App.exportData()">📤 Export</button>
    <button onclick="App.importData()">📥 Import</button>
</div>
```

## 数据安全建议

### 1. 定期备份
- 每周自动提醒用户导出备份
- 浏览器关闭前提示备份

### 2. 数据验证
- 导入前验证数据完整性
- 检查版本兼容性
- 防止数据损坏

### 3. 加密存储（可选）
- 敏感内容加密
- 密码保护导出文件

## 总结

### 当前最佳方案
1. **立即实现**: JSON 导出/导入（备份恢复）
2. **短期实现**: HTML 导出（分享阅读）
3. **中期规划**: 云端同步（多设备）
4. **长期愿景**: 企业级产品（协作、AI）

### 技术栈建议
- **前端**: 保持当前架构（模块化 JS）
- **导出**: 纯前端实现（无需后端）
- **云端**: Node.js + PostgreSQL + S3
- **移动端**: React Native（代码复用）

这样的方案既能满足当前需求，又为未来扩展留有空间。
